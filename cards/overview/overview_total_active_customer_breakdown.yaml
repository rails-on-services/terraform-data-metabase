---
overview_total_active_customer_breakdown:
  name: Overview - Total Active Customer Breakdown
  description: Managed by Terraform.
  native_query: |2
    WITH date_filter AS (
        SELECT
            TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{start_date}}), {{timezone}}) AS start_date,
            TIMESTAMP_ADD(TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{end_date}}), {{timezone}}), INTERVAL 24 HOUR) AS end_date
    ),
    returning_user AS
    (
    SELECT cognito_user_id
    FROM  `whistler_views.http_log`, date_filter
    WHERE (CAST(tenant AS STRING)={{tenant}}  or 1=1)
    AND request_time BETWEEN  date_filter.end_date AND TIMESTAMP_SUB(date_filter.end_date, INTERVAL 32 DAY )
    )
    SELECT CASE  WHEN TIMESTAMP_DIFF(end_date,start_date,HOUR)<=1*7     THEN TIMESTAMP_TRUNC(request_time ,HOUR)
                 WHEN TIMESTAMP_DIFF(end_date,start_date,HOUR)<=1*7*24  THEN TIMESTAMP_TRUNC(request_time ,DAY)
                 WHEN TIMESTAMP_DIFF(end_date,start_date,HOUR)<=1*7*24*7 THEN TIMESTAMP_TRUNC(request_time ,WEEK)
           ELSE TIMESTAMP_TRUNC(request_time, MONTH)  END AS date,
              COUNT(DISTINCT (CASE WHEN returning_user.cognito_user_id IS NULL THEN log.cognito_user_id ELSE NULL END ) ) AS new_user,
              COUNT(DISTINCT (CASE WHEN returning_user.cognito_user_id IS NOT NULL THEN log.cognito_user_id ELSE NULL END ) ) AS returning_user
    FROM  `whistler_views.http_log` log, date_filter
    LEFT OUTER JOIN returning_user
    ON log.cognito_user_id=returning_user.cognito_user_id
    WHERE (CAST(tenant AS STRING)={{tenant}} OR 1=1)
    AND request_time BETWEEN date_filter.start_date AND end_date
    GROUP BY 1
    ORDER BY 1
  variables:
  - name: start_date
    type: date
    display_name: Start Date
    required: true
    default: null
    embedding_param: enabled
  - name: end_date
    type: date
    display_name: End Date
    required: true
    default: null
    embedding_param: enabled
  - name: timezone
    type: text
    display_name: Timezone
    required: true
    default: Asia/Singapore
    embedding_param: enabled
  - name: tenant
    type: text
    display_name: Tenant
    required: true
    default: null
    embedding_param: locked
  database_id: ${database_id}
  enable_embedding: true
