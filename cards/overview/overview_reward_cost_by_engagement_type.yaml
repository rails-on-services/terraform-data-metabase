---
overview_reward_cost_by_engagement_type:
  name: Overview - Reward Cost by Engagement Type
  description: Managed by Terraform.
  native_query: |2
    WITH date_filter AS (
        SELECT
            TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{start_date}}), {{timezone}}) AS start_date,
            TIMESTAMP_ADD(TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{end_date}}), {{timezone}}), INTERVAL 24 HOUR) AS end_date
    )
    --Perx::InstantOutcome::Transaction
    SELECT
      RTRIM(LTRIM (actual_outcomes.source_type,'Perx::'),'::Transaction'),
      SUM(reward.cost_of_reward )
    FROM
      `perx-whistler.whistler_views.actual_outcomes` actual_outcomes,date_filter
    INNER JOIN
      `perx-whistler.whistler_views.vouchers` vouchers
    ON actual_outcomes.result_id = vouchers.id
    AND actual_outcomes.result_type ='Perx::VoucherService::Voucher'
    AND actual_outcomes.tenant =vouchers.tenant
    INNER JOIN `perx-whistler.whistler_views.rewards` reward
    ON reward.id =vouchers.source_id  AND vouchers.source_type ='Perx::Reward::Entity'
    AND reward.tenant =vouchers.tenant
    WHERE
      (actual_outcomes.tenant={{tenant}} or 1=1)
      AND actual_outcomes.created_at BETWEEN start_date AND end_date
      AND vouchers.status  IN ('issued','redeemed','expired')
    GROUP BY 1
    ORDER BY 1
  variables:
  - name: start_date
    type: date
    display_name: Start Date
    required: true
    default: null
    embedding_param: enabled
  - name: timezone
    type: text
    display_name: Timezone
    required: true
    default: Asia/Singapore
    embedding_param: enabled
  - name: end_date
    type: date
    display_name: End Date
    required: true
    default: null
    embedding_param: enabled
  - name: tenant
    type: text
    display_name: Tenant
    required: true
    default: null
    embedding_param: locked
  database_id: ${database_id}
  enable_embedding: true
