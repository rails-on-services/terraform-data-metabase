---
overview_running_campaigns_breakdown:
  name: Overview - Running Campaigns Breakdown
  description: Managed by Terraform.
  native_query: |2
    WITH
      date_filter AS (
      SELECT
        TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{start_date}}), {{timezone}}) AS start_date,
        TIMESTAMP_ADD(TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{end_date}}), {{timezone}}), INTERVAL 24 HOUR) AS end_date )
    ,game_engaged AS (
      SELECT
         games.game_user_id  AS id,
         games.game_updated_at AS DATE
      FROM
        `warehouse_views${suffix}.games` games,
        date_filter
      WHERE
        (games.tenant={{tenant}}
          OR 1=1)
        AND game_updated_at BETWEEN date_filter.start_date
        AND date_filter.end_date
       ),
      survey_engaged AS (
      SELECT
          survey.survey_user_id  AS id,
          survey.survey_updated_at AS date
      FROM
        `warehouse_views${suffix}.survey` survey,
        date_filter
      WHERE
        (survey.tenant={{tenant}}
          OR 1=1)
        AND survey_updated_at BETWEEN date_filter.start_date
        AND date_filter.end_date
    ),
      instant_rewards AS (
      SELECT
       instant_outcomes.instant_outcome_transaction_user_id   AS id,
       instant_outcomes.instant_outcome_transaction_updated_at AS date
      FROM
        `warehouse_views${suffix}.instant_outcomes` instant_outcomes,
        date_filter
      WHERE
        (instant_outcomes.tenant={{tenant}}
          OR 1=1)
        AND instant_outcomes.instant_outcome_transaction_updated_at BETWEEN date_filter.start_date
        AND date_filter.end_date
     ),
    reward_redeemed AS
    (
      SELECT reward.id as reward,
      reward.updated_at as date
      FROM `warehouse_views${suffix}.vouchers` reward,date_filter
      WHERE status ='redeemed'
      AND  (reward.tenant={{tenant}}
          OR 1=1)
     AND reward.updated_at BETWEEN date_filter.start_date AND date_filter.end_date
    )
    SELECT
        CASE WHEN TIMESTAMP_DIFF(end_date,start_date,HOUR)<=1*7     THEN TIMESTAMP_TRUNC(process_date  ,HOUR)
             WHEN TIMESTAMP_DIFF(end_date,start_date,HOUR)<=1*7*24  THEN TIMESTAMP_TRUNC(process_date ,DAY)
             WHEN TIMESTAMP_DIFF(end_date,start_date,HOUR)<=1*7*24*7 THEN TIMESTAMP_TRUNC(process_date ,WEEK)
             ELSE TIMESTAMP_TRUNC(process_date, MONTH)  END AS date,
        100               AS  Click,
        COUNT(id)         AS  Engaged,
        COUNT(reward)     AS Redeemed
    FROM (
    SELECT date AS process_date   ,  NULL AS id,  reward FROM reward_redeemed
    UNION ALL
    SELECT date AS process_date   , id,       NULL      FROM game_engaged
    UNION ALL
    SELECT date AS process_date   , id,       NULL     FROM survey_engaged
    UNION ALL
    SELECT date AS process_date   , id,       NULL      FROM instant_rewards
    ) ,date_filter
    GROUP BY 1
    ORDER BY 1 ASC
  variables:
  - name: start_date
    type: date
    display_name: Start Date
    required: true
    default: null
    embedding_param: enabled
  - name: timezone
    type: text
    display_name: Timezone
    required: true
    default: Asia/Singapore
    embedding_param: enabled
  - name: end_date
    type: date
    display_name: End Date
    required: true
    default: null
    embedding_param: enabled
  - name: tenant
    type: text
    display_name: Tenant
    required: true
    default: null
    embedding_param: locked
  database_id: ${database_id}
  enable_embedding: true
