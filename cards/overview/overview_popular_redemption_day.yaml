---
overview_popular_redemption_day:
  name: Overview - Popular Redemption Day
  description: Managed by Terraform.
  native_query: |2
    WITH date_filter AS (
        SELECT
            TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{start_date}}), {{timezone}}) AS start_date,
            TIMESTAMP_ADD(TIMESTAMP(FORMAT_TIMESTAMP("%Y-%m-%d %H:%M:%S", {{end_date}}), {{timezone}}), INTERVAL 24 HOUR) AS end_date
    )
    SELECT
        EXTRACT(DAYOFWEEK FROM DATE(updated_at, {{timezone}})) AS `dayname`,
        CASE
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 0 AND 5   THEN '6am'
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 6 AND 8   THEN '9am'
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 9 AND 11  THEN '12nn'
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 12 AND 14 THEN '3pm'
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 15 AND 17 THEN '6pm'
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 18 AND 20 THEN '9pm'
            WHEN EXTRACT(HOUR FROM DATETIME(updated_at, {{timezone}})) BETWEEN 21 AND 23 THEN '12mn'
            ELSE 'Unknown'
        END AS `time`,
        count(*) as count
    FROM `perx-whistler.whistler_views.vouchers` vouchers, date_filter
    WHERE
       -- (rewards.tenant={{tenant}} OR 1=1) AND
        vouchers.status ='redeemed'
    AND created_at >= date_filter.start_date
    AND created_at <= date_filter.end_date
    GROUP BY 1,2
    ORDER BY 1,2
  variables:
  - name: start_date
    type: date
    display_name: Start Date
    required: true
    default: null
    embedding_param: enabled
  - name: timezone
    type: text
    display_name: Timezone
    required: true
    default: Asia/Singapore
    embedding_param: enabled
  - name: end_date
    type: date
    display_name: End Date
    required: true
    default: null
    embedding_param: enabled
  - name: tenant
    type: text
    display_name: Tenant
    required: true
    default: null
    embedding_param: locked
  database_id: ${database_id}
  enable_embedding: true
